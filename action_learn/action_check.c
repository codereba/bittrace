/*
 * Copyright 2010-2024 JiJie.Shi.
 *
 * This file is part of bittrace.
 * Licensed under the Gangoo License, Version 1.0 (the "License");
 * you may not use this file except in compliance with the License.
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include "common_func.h"
#include "ring0_2_ring3.h"
#include "action_type.h"
#include "action_check.h"
#include "action_source.h"
#include "static_policy.h"
#include "action_group_policy.h"
#include "action_policy_common.h"
#include "action_learn.h"

group_policy_nfa group_nfa; 

//#define IMPORTANT_FILE_PATH 

/********************************************************
action abstraction layer:
1.instruction and memory data
2.api and parameters
3.action detail type
4.action type
********************************************************/

/***********************************************************
���ʽ��Ϊ״̬��
ͨ������Ϊ���в���ƥ���������ƥ����������Ӧ�ı�ǡ�ͨ��
�����γɱ�Ǽ�������ʾ��ΪԴ�����ԡ���������Ŀ���ǵõ���Ϊ
Դ�����ԣ�
***********************************************************/

/**********************************************************
��ǰ��ȫ��������������
1.ʹ��Ԥ��̶����жϲ�������֤�����ִ������ȫ�ԡ�
2.ʹ�����ܷ�����������֤�����ִ������ȫ�ԡ�
***********************************************************/
/****
����ֻ������Ϊ��ΪԴ�ķ����ʹ������Ͷ���Ϊ���ļ�ӣ��򵥷����ʹ�����
ʹ�����ܷ�����ʽʱ������ʹĿ����ΪԴ����һЩ��Ϊ�����û���ض�����
֧�֣�����ΪԴ�ڷ������ǰ���ƻ�����Ϊ�����ᱻ��ֹ��
�ض���������һ���ĸ����ԣ�ȫ�濪����Ҫһ����ʱ�䡣ʱ�����ƻ���Ϊ��
����ҪȨ�⡣
****/

/**************************************************************
���ܺ��û��������й��̣��û�����ʵ�����������
1.
���ӣ��������ܣ�
ȫ��ȫ��ϵͳ�����磬�ļ���Ӳ�̣�ϵͳ������Ϊ��־��ʵʱ������档
��Ļ����ʾ�����ݰ�����
1.��Ϊ����
2.��ΪԴ����
3.��ΪĿ������
4.��Ϊ���ԣ����а�����Ȩ�ޣ���ջ���ٵȣ�
	1.��Ϊ���ݣ����а��������������ݺͳ��ȣ�
	2.��Ϊ���ݷ���
		1.���ܷ�����ͨ������ΪԴ��Ϊ�����ó�
		2.�˹�Ԥ�ù��������ͨ��Ԥ�����õĹ�����з���������Ϊ
		ԴID��ʶ��

�û�������
���ø�����ΪԴ�ķ�Χ���������̣������飩��1�����̣�ȫ��ϵͳ��
���ø�����ΪԴ�Ĺ���������������������ƣ�����ֵ�ȡ�
*
1.���ø��ټ���
2.�Ƿ�������ݷ���
3.���ݵ���󳤶�����
3.�Ƿ�����������ܽ���

�û����ࣺ
1.1���û�����������������ܶԼ������Ϊ�����κη����Ϳ��ơ�
2.2���û����Լ�����л����˽⣬���Խ����������������ݼ򵥵���Ϊ
�����Ϳ��ơ�
3.3���û����Լ����������Ϊ�������⣬���Խ��и�����Ϊ�ķ����Ϳ��ơ�

�û�����ʵ�ַ�����
���2,3�����û�Ⱥ�������䴦��������������⣬�ҳ�����ԭ�򡣷���
��ǰ�������̬������״̬��

ʵ�ּܹ�����:
1.��ȫ���ܻ����ܹ�:
	1.ȫ��ĸ���������Ϊץȡ������ϵͳ��
	2.ȫ��ĸ���������Ϊ�����ܲ��ԣ�Ԥ�ò��ԡ�
2.��־������棬ģ�顣
3.�û����ƣ���ʾ���档

2.���ƣ��������ܣ�
ʵ�ּܹ�������
1.��ȫ���ܻ����ܹ�
2.���ܲ��ԣ�Ԥ����Ϊ�����ݷ������ԡ�
3.������Ӧ�������
4.�޷���ȷȷ����Ӧ���ʱ���û������жϽ��档

�û�����ʵ�ַ�����
���1��2��3�����û�Ⱥ��ֱ�Ӽ�⣬����ϵͳ�������͵���Ϊ������Ϊ
�������ܷ���������ֱ��������Ӧ����͸�����������û�û�ио�������£�
���ƻ���Ϊ���д��������ڲ��ܾ�ȷ������ʱ���Լ���ķ�ʽ�õ��û�
�ĸ��������������û���ʹ�ü����ʱ�������ĸ��֣����磬�ļ�ϵͳ��
Ӳ�̣�ϵͳ���ݽṹ���ƻ�����Ϊ����ֹ������
�ƻ���Ϊ������
�ƻ���Ϊ���ࣺ
1.��Ϣ��ȡ
2.�����ƻ�

1.��Ϣ��ȡ��
���������ƻ������ϵͳ�ؼ����̽���ע�룬�����ݽ��ж�ȡ�����䡣
�ּ���
1.4�����û�����й¶�Ļ������ݣ���˽���ݡ�
2.3�����û�����й¶���ܲ�������Ӱ�졣
3.2�����û�����й¶����Ҫ����һЩ�������ء�
4.1�����û�ϣ�����ݿ��Է�����

2.�����ƻ���
1.4��������
2.3����һ��
3.2��������
4.1����ϣ��

�û�Ⱥ������ȷ�����
1.�û�Ⱥ�������м�����û���ÿһ̨������������û���ϣ��й¶�����ݡ�
2.��������û����ݵ���Ҫ�̶ȶ���ͬ��ͨ��ÿ̨�����������2��3���ڵĹؼ����ݡ�

�û����������Ӵ������һ�㡣

�Ƿ���Ϊ����ʵ�֣��ǣ���Ҫ��2����

2.ϵͳ״̬���ӣ�ά����
1.��ϵͳ������Σ������״̬���з�����
	1.CPU��Դռ�á�
		1.�ҳ�����ȷռ��CPU�Ľ��̣���ֹռ����Ϊ��
	2.�ؼ�ϵͳ�����ļ������ݵı������ҳ��ƻ���Ϊ��������ֹ��

2.�Ը��ֹؼ�������и�����Σ������״̬��أ�������������
	1.�������й��ܵ���ȷ�ԣ����з������ҳ�����ȷ������Ϊ������
	��ֹ��

	1��2��3���û�������������ȶ��ߡ�

��ǰ�û����ݰ�ȫ��ϵͳ��ȫ��Ӧ�ð�ȫ����ʵ�ַ������û����⣬����ʵ�ֶȷ�����
1.ɱ������
	1.��ɽɱ�����̶����ԣ����������������룩����̬�������ϵ���ֹ��ɾ���ƻ���Ϊ���ܡ�
	2.360ɱ�������ɽʵ�ַ�ʽ��ͬ��
	3.360��ȫ��ʿ���в��ֶ�����̬ɱ�����ܡ����в���ϵͳ���ܴ���̬��������������̬���������������ܡ�
	4.������õĲ��Լ�ʽ����������HURONG���������ȶ��ԣ�������������δ֪�ģ�û��ʵ�ʳɹ��Ĳ��Ծ��顣

2.�û��İ�ȫ������Եõ��󲿷ִ��������⹦�ܣ��ڲ�����һ���ȶ��ģ������ʽϸߵİ�ȫ�������ƣ�����������ǿ�������ȶ��ԱȽϸߣ��������֣�����50%����ϵͳ���ܴ�����Եõ���������̬����
  �����û������ݰ�ȫ���Եõ���ӵİ�ȫ���󲿷ֵİ�ȫ������
  ������һ����û�еõ�ע���֧�ֵ�ϵͳ���ܴ���û����Ӧ���������ܡ���̬��������һ���̶ȵ����ܴ������ܡ�
  ���Ƚϵͣ���
  ��������2��3���û���Ҫ�����˽�ϵͳ��Ϊ������

��Ҫ�������ַ�����
HURONG:
������ԱӦ����10�����ң�����ȷ�����е��ȶ��������ж��٣������ܾ���һ�������ˮƽ�����ڿ��ܻ���û��ʵ�ֿ�����Ӫ�����棬���ڿ����׶Ρ�
��ɽɱ����
������Ա��50-100�����ң��ȶ�������Ա��50�����ң�������ȫ�棬��Ӧ�������ٶȸߡ�

��������
���Զ���������ϸ�ڽ���ȫ��ķ�����ȫ��ķ���������Ҫ���굽һ���ڣ�ÿ��8Сʱ��Ͷ��ķ���������

������û��ʵ�����棬�вο���ֵ����������Ϊ��������
��ɽɱ������Ϊ�������ο�����������
������ʽ�Ǵ�С���ܣ���ȫ�棬��ȷ�����ɡ�������߳�Խ�Ѷȣ�5������
���Բ����Դ��ȫ�ķ�ʽ���в�Ʒ��ƣ�������ȫ������ƣ��������̶�������ʱ�䣬Ч�ʳ��������о�ȷ�ļ��㡣

����ԭ��
���ʵ���û����������죬Խ���Ĺ���Խ�ѣ�Խ��Ҫ����ʱ�䣬FEATUREԽ�͡�

���������
��ɽɱ���Ķ�̬�������ܣ�û�з�������չʾ����������2��3���û����󡣣���ֵ2��ʵ�ָ��Ӷ�2����Խ���Ӷ�1.8����
��ɽɱ����̬�������ܣ�û���㹻���������Ծ����ɹ���
��ɽɱ����̬�������ܣ�������ʽ�ģ�����ȷ��������������𡣿��ܱȽϵͣ���Ϊ���㡣

������������
1.����ʵ�ֹ���
	1.����ʵ����Ϊ��������Ϣ�������2��3���û��˽�ϵͳ����Ϊ���̡�
	2.����ȷ������ʵ�ֱȽ�ɽɱ����ǿ��Ķ�̬����������ͬʱ�����ϵ�
	ɱ�����������ܴ������ϲ��ܳ�Խ��������ʱ��̫�٣�

����Ч�����ƣ�
1.����Ӯ�ò���2��3���û���ʹ�á�����ҵ�����ڴ��£�ͬʱ����ҵ�ڴﵽ��ѣ�����һ����������
2.���޷�Ӯ��1���û�����ֻ��Ҫ�������ܣ�û�з��������2��3���û�����Ϊ�޷���Խ��ɽɱ���ı������ܡ�
��ʹ��̬�������������㹻ǿ��Ҳ���������յı������ܺ�Ч���Ϻͽ�ɽɱ��������

����ʱ����ƣ�
1.�Ѿ������ɹ���Ϊץȡϵͳ��Ҫ��ܡ�
2.��ƽ���ϵͳ��Ϊ����ϵͳ����Ҫ1���¿�����1�汾��3�������ҵ���ɢʱ������ƣ����������ɵ�1�ȶ��汾��
3.��������ƣ�ֲ����Լ�����Ҫ2�����ڷ�������ƣ�������2�����ڽ������ƣ����������ԣ����ɵ�1�ȶ��汾��
4.1��������֯�û����档
5.3���������й������������ƣ�ʵ���������ܼ����ȶ����С�
6.���з�����

�����ܹ���Ҫ6���µ�ʱ������ɿ�����

������ֵ������
1.Ӯ�ò���2��3���û���
2.�����ɹ���90%���ϡ�
3.�����ر����ƹ㷽ʽ����Ȼ�ƹ㡣����һ������10�򣩵��û�Ⱥ��Ҫһ����ʱ�䡣�������+����ģʽ����ѵ�1�汾�ر��Ƚ�����
4.������50%֮�ڣ���������������������Ա���ɽ��������Խ����������Ƚ��٣���Ϊ���������ܹ������Ѷȴ�ֻ������н϶�
�������ҵ�ڵľ������־�����
5.һ�������û�+һ�������û��ٶ�+50%��ҵ�����޶��־�����-6���»���ȫ���Ŀ���ʱ�䡣�Ƿ�ֵ�ý��У�

���������ܼ�ֵ������
������
�������飬��������Ҫ�󲻸ߣ�����һ������+���ʺ���Դ=��ʱ����۰����û�Ⱥ��
�ܿ���ʱ����ƣ�
1.1������1����֮�ڣ�����������еĿ���+���ԣ��γɵ�1���汾��
2.��Դ������Ҫ1-6���¡�


��������������·��
1.������·����Ҫ��Դ���۽ϸߵĳɱ���
2.������·����Ҫ�����Ŀ�������ʱ�䡣

����ռ��ҵ�ɹ�ԭ���20%-30%��������Դ����ƣ����⣬Ӧ����Դ����ϵ��Դ�����ƹ㣬����ռ����70%��



���������ܣ�
�û����������
���Զ���Ϊ�����˹�Ԥ�ÿ��ƣ����ǿ��Ʒ�ʽ�ֲڣ��򵥣�ʹ�û��޷�����
����Ч��ʹ�ü��������Ӧ�ù��ܡ�
�û�Ⱥ������ȷ�����
1.�ؼ���ȫ�ԣ�Ӧ�õ�һ��ҵ���û�������ȸߡ�
2.һ���û��л������󣬵�ʵ�ּ�����Ч�����ܱ����ܡ������Ϊ���͡�

�������Ƿ�ʵ�֣�
1�񣬵����Լ���С�͵���ؼ��������


**************************************************************/

/**************************************************************
�û�������̣�UI������
1.��������ƣ�
	1.ϵͳ��Ϊ����
	2.�������
	3.������
	4.����

	1.ϵͳ��Ϊ����
		1.�г�ϵͳ�е�������Ϊ
		2.�г�ϵͳĳ����ĳ������ΪԴ����Ϊ����ʹ��������ʽ���й��ˡ�
		��ΪԴ�����������̼���JOBS�������ӽ��̼����������̣������̣߳���

		3.����ΪԴ����Ϊ�����з������ҳ�ƥ�����Ϊ��������Ϊ���ĺ��塣
		4.������������ץȡ�������ݿ���з��롣
		5.�Է�������������á�
		6.SQL��ѯ���֧�֡����߼����ܣ�

	2.�������
		1.�г�ϵͳ�������棬��εĲ��ԡ�
		2.����ָ����Ϊ�����Եĺ��塣
		3.����ָ����Ϊ��������Ӧ��ʽ����ֹ����������

	3.������
		1.�����г����ָ������ߣ�Զ�̿��ƣ�©���޸��ȣ���

	4.����

	1.�û����������
		1.2��3���û���Ҫ��ϵͳ��Ϊ������������������ķֽ⣬�г���
		���Դﵽ�г������Ч����
		2.1���û���Ҫֱ�Ӷ����е��ƻ���Ϊ����ΪԴ���д�����ʵ��
		�������ޡ���1�汾���ܳ�Խ�κ�һ��רҵɱ��������
		���Ʒ�����
		1.�Զ�̬�����������ƣ���Խ��̬�����������Ӷ�̫�ߣ���
		2.���뾲̬�������������п���������ʱҪ��̫�ߣ�����������
		ɱ�����̺�����

	2.���������
		1.�ۻ�10������3��4��5���û���ͨ��������Ȩ����������ȷ�ʽ�õ�3000/������
		��Ȼ�ƹ㷽ʽ��������Ҫ�����ʱ�䣬ͬʱ��Ҫ���ϵĿ���������

	3.��Ʒ���Ĺ��ܣ�����
		1.���Ĺ����Ƕ�̬����������������������Ϊ����̬������ʵ���Ѷ�9����ҵ��ʵ���Ѷ�3����

	4.����
	�û���Ȼ��Ҫ���㣬������Զ�����Է�ʽ��������Ҫ������������Ϊ���з�����ǿ�󣬼������
	������Է�ʽ��

	�ڶ�̬����֮�⣬�û�����Ҫʲô���ܣ�
**************************************************************/

/**************************************************************
�����ܹ���ƣ�
1.���ģ�����ܹ�
2.ģ����չ�ܹ�
3.����ģ����չSDK

���ģʽ��
��װģʽ

�����㷨��
B��
���Լ�״̬��
**************************************************************/

/**************************************************************
������Ҫ�¿����������
1.SANDBOX��
	1.�о���������ָ��֧��(COMODO)��

**************************************************************/

/**************************************************************
֧�ֵķ�����������Ϊ���ͣ�
1.��дϵͳ�ؼ����ݣ���Ϊ��
2.
**************************************************************/

/*************************************************************
����о���
1.������������ȼ������ļ���
	1.�ƻ����򲻿��Ա���ء�
	2.�ƻ����򲻿��Ա�ִ�С�
	3.�ƻ�����ʹִ�У�Ҳ���ܲ����ƻ���

BITSAFE�Ķ�Ӧ���ܣ�
	1.�ƻ����򲻿��Ա���ز���ֱ��ʵ�֣���Ϊ������Ҫ�����������
	���⣨��̬������������һ�֣�����������SANDBOX�ȷ�����������
	ɾ����ʵ�ָ��Ӹ��󣬶Դ˹���ֻ�������ּ�ӷ�ʽʵ�֡�
	2.�ƻ����򲻿��Ա�ִ�У����ܱ�ʵ�֣�ֻҪ��̬���������㹻��ȫ
	��������ϵͳ�������棬���Լ��㹻���ơ�
	3.�ƻ�����ʹ��ִ�У�Ҳ���ܲ����ƻ������ܱ�ʵ�֣�ֻҪֻҪ
	��̬���������㹻��ȫ��������ϵͳ�������棬���Լ��㹻���ƣ�
	����ֹ��Ӧ��Ϊ����Ӧ���ɡ�

��ȫ������ߣ�Ҳ�������������
������ �����ڰ�ȫҪ�󲻿ɳ����ĳ�����
����������̬�����⣩ �����ڰ�ȫҪ��һ��ĳ�����
��̬���� �����ڰ�ȫ����һ����͵ĳ�����

��̬����ֻ�������޵ķ���������Ϊû���˹�����ѧϰ��������
��ʵ�ֵķ�ʽ��Ϊ���ӡ������Խ���������˼����Ϊ�����еĲ������
�����У�ʵ�ְ����������ȫ�ԡ�Ҳ����˵������ͨ������ʹ��̬����
��Ϊ���������ܡ�

��̬�����Ľ����������ʹϵͳ�����лع���ƽ�⣬��ȷ���������Զ�����
�������棬��ε�ϵͳ���󣨰����ƻ����ܣ���Ϊ��

�û�ʹ�ü�����ı���������ִ��һ�ξ��������ܵ�ָ�����С���Ҫ��
�����Ŀ����Ҫ��Щ֧�֣�
1.���㣬��ȷָ�����У���ִ���ļ�����Դ����Դ��
2.�û��Կ�ִ���ļ�������ȷ�����ƣ��ȶ��Եķ���������
3.�ⲿ�������ܣ�ȷ��ָ�����й��ܵ���ȷ�ԡ�����̬������������Ҫ
��ʵ�ּ���֮һ��Ҳ�ȷ�����о�̬����������ϵͳ��

�ⲿ�������ܣ���ʵ�ַ��˹�ָ��������ȷ���жϵı��뼼����
����ָ�����ж�̬�������ܾ��кܴ���û�����������3��4��5������ȡ�

�û�������������ܱȽϺ���С��Χ���г����û�Ⱥ����û�и�����û�
������������

BITSAFE��1�汾����������̬�������ܣ�ִ�����¿������̣�
1.��̬����ϵͳ
2.�ں�+Ӧ�ò�SANDBOX
3.�ӿڹ��ܼ���������ƺõ��û�������̡����������ģ��ܹ���
4.�û��������ܼ�
**************************************************************/

/****************************************************************
��̬���Լ��������̣�
1.ÿ����ΪԴ�о���һ����Ϊ״̬������Ϣ�ṹ��
2.
****************************************************************/

typedef struct _POLICY_NODE 
{
	LIST_ENTRY entry; 
	action_policy policy; 
	ULONG flags; 
}POLICY_NODE, *PPOLICY_NODE; 

/************************************************************************
current action analyze nfa version use process to be the unit of 
the action source.
************************************************************************/

/******************************************************************************
how can do the policy checking ?
1.one action bind one action check function.
2.all action use one checking function�� this function checking all action 
by its type.
******************************************************************************/
/**************************************************************************
��Ϊ������ڲ��ṹ:
1.����һ����Ϊ���������м����еĲ��Զ��ǲ�ͬ�ġ�
2.�������Ĳ��Ժ�δ�����Ĳ��Է��ڲ�ͬ�������С�
3.ÿ�����µ���Ϊ����ʱ�����������������н��м�顣
4.ÿ�����µĲ��Ա�����ʱ������������������Ĳ����飬����в����飬��������
�����Ĳ��Զ�������������ִ�д˲������Ӧ����Ӧ��
5.ÿ��������ͬ�Ĳ���ʱ���������²��ԣ����ǽ����������������������ӡ�
**************************************************************************/

/****************************************************************************
1.������һ��ȫ�ֵĸ������ϵͳ�е����е���ΪԴ��ͬʹ��ͬһ�ײ���ϵͳ��
���Բ����ʶ�ÿһ����ΪԴ����һ������ϵͳ��
2.��ΪԴ����һ��ʱ�䷶Χ֮�з���һ����������Ϊ�������ģ��������Ⱥ��ʱ��ġ�
3.��ΪԴ����Ϊģʽƥ��Ӧ�ü�¼�������ΪԴ����Ϊ״̬��¼�ṹ�С�

*****************************************************************************/

/****************************************************************
action checking mechanism design rule:
1.use more region rule
2.use simplest region rule description
3.use quickest algrithm for the comparing between the action and the rule
4.use fewest rule.
****************************************************************/

/***********************************************************************************
ϵͳ����Ϊ��������
1�ļ�
2ע���
3Ӳ��
4����
5�ڴ��д
6ϵͳ���Ͷ������

��Ϊ����
����
����
�߳�
������ض���
�û�
Ȩ��

����
�ļ�
ע���
Ӳ��
ϵͳ���Ͷ���
�ڴ�

ϵͳ��Ϊ�Ĵ�����Σ�
1.��ͷ���Թ�������
2.�������+�������ô���+api���÷���
3.���������(�����API����ϸ��)

ϵͳ����Ϊ���ķ�����Σ�
1ֱ�Ӷ���Ϊ�Ķ�������жϡ�
2����Ϊ��
�ڵ����ļ�IO�Ĺ���ʱ���Ƚ���Ȩ�޵��жϣ�������EXE�ļ��ķ���ϵͳ���жϴ�EXE�ļ��Ƿ��
�д��ļ���Ӧ��IO����Ȩ�ޣ����û�У���ܾ���IO��
�û�����
1���ļ����տɷ��ʵ�Ȩ�޻���Ϊ��
	���û������л���
	1�����û������г���������ʱ�乲��
	2˽���û������ض���ʱ���·���

	�����������л��֣�����ʵ��û����Ӧ�����󣩣�
	2�������������ض�ʱ���·���

�Ҳ��˽�ϵͳ�ﵽ����ʲô����������Ҫ��֤ϵͳ�ؼ�����Ϣ�������Ķ���

�Ҳ��˽�ϵͳ�ﵽ������ʲô�������Ҳ��������κζ��ҵ����ݣ�ϵͳ����Ϣ�����ĳ�������

ϵͳͻȻ����������ϵͳ���ڽ���ʲô��������ʲô���̣������������ڽ���ʲô������

�Լ������һ���˽���û���
����Ҫ�˽�ϵͳ�����еĳ�������ʲô���飬�����д��ʲô�ļ���ע��������磬�����������ʲô��

����ͻȻֹͣ������������ֹͣ��ԭ��
ץȡ������ֹͣǰ����Ϊ����

�ж�һ��ϵͳ��Ϊ�Ƿ���Ч����Ҫʹ��������Ϣ��
1����EXE�ļ�
2�������ļ�·����ע���·�����򱻷�����Ϣ·��
3�������Ϊ
4�Դ�EXE�ļ��ķ���������û����ж�

�˹�����ϵͳ��Ϊ�Ĺ��̣�
1.����ϵͳ��Ϊ����
2.ץȡϵͳ��ΪAPI�͹ؼ��������ؼ�����
3.�ҳ�������Ӧ�Ĵ���κ���ش��룬����ȷ������ľ���ϸ�ڹ�����ʲô
4.������Ӧ��Ϊ�ж�

�������������ϵͳ��Ϊ�Ĺ��̣�
1.�˹�����ϵͳ��Ϊ����
2.������ڲ�ץȡ���API���ã��ؼ����ݣ�������ش��� 
3.�����ʹ��ֱ��API���ù���+�ؼ����ݲ���������Ӧ����Ϊ���з������ҳ���Ӧ�ķ�Ӧ��Ϊ��
4.�����ʹ��API���ø���(��API������(һά��))����������Ӧ����Ϊ���з������ҳ���Ӧ�ķ�Ӧ��Ϊ��
5.�����ʹ��API������+ϵͳ����״̬+�ر�����+����ά����Ϣ����Ӧ����Ϊ���з������ҳ���Ӧ�ķ�Ӧ��
6.�����ʹ��API������+�Զ�������ػ�����(ģʽ������ֱ�ӷ���)+����ά�ȵ���Ϣ����Ӧ����Ϊ���з�����
7.���������ά+��ѧϰ������Ӧ����Ϊ���з���
8.�˹�����

BITSAFE��Ҫʵ�ֵķ�������
1.API����+�ؼ�����=��Ӧ
2.API������+�ؼ�������=��Ӧ
3.API������+��������ģʽƥ��=��Ӧ
//4.API������+����������=��Ӧ

BITSAFE�Ļ����ܹ���
��������
1.ϵͳ�����ͣ��������Ϊץȡ��ץȡ���ͣ�1.ǰץȡ(ִ�з�Ӧ��Ϊ)2.��ץȡ(��¼ϵͳ��ʵ��Ϊ��
������Ϊ��

�м书��(ģʽƥ��):
2.��ϵͳ��Ϊ����Ϊ���˹�����ƥ��ģʽ�ͷ�Ӧ
ע:�����漰���ǳ����ϵͳģʽ��������Ҫ����ϵͳ�ڸ�������µ���Ϊ���Ӧ�Ĺ������塣
(����ʹ��PROCMON��ץȡϵͳ��Ϊ)BITSAFEҪ�ṩǿ���ϵͳ��Ϊץȡ���ܡ�

���湦��(��Ӧ)
3.���û�����ķ�ʽ����Ϣ�ͷ�Ӧ������û�

BITSAFE��δ���ܹ�:
1.��ϵͳ��Ϊ����Ϊ�������ѧϰ�������ԡ�
2.��Ϊ��Ӧ��ѧϰ���ܡ�

һ���������ͬ��Ӧ���������Ͳ������
�����������ͬ��Ӧ���������Ͳ��Ծ���
�����������ͬ��Ӧ���������Ͳ�������

***********************************************************************************/

/***********************************************************************************
1.ϵͳ��Ϊ���ռ�?
	1.ϵͳ��Ϊ�Ƿǳ�Ƶ��������ģ���ν�������Ϊ�ɶ���ϵͳ��Ϊ��ɵ���Ϊ��
2.ϵͳ��Ϊ��ƥ��?
	1.��Щ��Ϊ����ؼ��ģ���Ҫ��Ϊϵͳ��Ϊƥ��Ƚϵ�������ֵ��
3.Ӧ�������Щϵͳ���ⶨ��ϵͳ��Ϊģʽ��
	1.���ϵͳ�ƻ���Ϊ(����)��������İ�ȫ������ϵͳ��Ϊ����ģʽ��

4.���Ϸ���
	1.kabԴ���е�HIPS��ϵͳ��Ϊ����������ʹ�ý�����Ϊ��ΪԴ��λ��(ʹ���߳��Ǹ��Ӻ�������ʵ��ϵͳ��ΪԴ��λ)
	2.HUORONGʹ���߳�����Ϊ��������λ

5.��ȷ��ֵƥ��ģʽ�Ƿ��ܹ�ʶ��ʵ���е�ϵͳ��Ϊ?
	1.ʵ����Ҫ�жϵ���Ϊ����һ���ķ�Χ�Ժ�ģ���ԣ���Щ������ν���ֵƥ������?

5.ϵͳ��Ϊ���ռ����̵��ƻ���Ϊ��������?
	1.ϵͳ��Ϊ��Ԫֱ�ӽ��д�������ֹ���������Ϊ��Ԫ��ִ�С�����Ϊ���ķ������ж���Ҫ
	������ģʽ�е�ǰ����Ϊ��Ԫ��������Щ��Ϊ���������ϵͳ�����ݵı仯����Щ�仯����
	�����ƻ��ԣ���Щ�ƻ�����δ���?���л�ԭ���м���ʵ�ַ���?
	1.�ض�����(sandbox)�������е�ϵͳ���ݵı仯�����ռ���������������Ϊ���ж���ɣ�
	��ֹʱ������ɾ����Ҳ��������������������ִ�ʹ�õĲ�������������
	2.��¼���е���Ϊ�����ݣ�����ֹ��ʹ�ü�¼������ȫɾ����

***********************************************************************************/

/**********************************************************************************
ϵͳ��Ϊ����ģʽ����
1.��ѹ�ļ����ٶȷǳ�����Ӳ����һЩ֨֨��Ѱ�����������ڲ���ϵͳ��Ϊϸ��Ϊ��
	1��ϸ�ڷ���
		1.��ѹ�����򿪣���ȡԴ�ļ���
		2.��ѹ���򽫶�ȡ���ڴ��Դ�ļ����ݽ��н�ѹ���㣬���������ݿ������ڴ�ռ��С�
		3.��ѹ���򽫽�ѹ�õ��ڴ�������д���ļ��С�
	2��ϸ�ڷ���
		1.�ļ��Ĵ򿪹��̣�
			1.�ҵ��������ļ����ڵķ���������
			2.�ҵ��������ļ���������
			3.�ҵ�����IO��ַ���жϺŵ�ͨ����Դ����������Ӳ��IOͨ�š�
	3��ϸ�ڷ���
		1.�ļ�ϵͳ����ϸ��:
			WINDOWS֧�ֵ��ļ�ϵͳ����:
			1.fat32
			2.ntfs(����������ͬ�汾)

			�ļ�ϵͳ����:

		2.��������ϸ��;
			
		3.��������ϸ��:

	4��ϸ�ڷ���
		1.ʵ�ʵ��ļ�ϵͳ����
		 fastfat.sys
		 ntfs.sys
		2.ʵ�ʴ���ϸ�ڷ���:

	��Ϣ�ռ��������ռ������:
		1.�ļ�ϵͳ���ʵ�
		2.Ӳ�̷��ʵ�

	ͨ��������������Ҫ����Ĺ��ܵ���Ϣ�ռ��������жϳ��ٶ�����ԭ��Ӳ��Ӳ��IO��Ӳ�̷���
	���ܣ��ļ�ϵͳ���ݣ��ļ�ϵͳ�������Ӷ���λ������ԭ��ʵ�ʽ��д���������û���Ӧ
	����ʾ��

	��λ�û���Ҫ�����ؼ�ϵͳ��Ϊ����ģʽ���ҵ���ʮ��ģʽ����ģʽ�ۺϴ���Ϊ��BITSAFE
	�Ĳ��Լ�������ʵ�ַ�ʽ���ȽϷ�ʽ����Ϣ�ռ��㣬�ռ������ķ�ʽ����Ϣ������������
	��Ϣ�����û���ʽ�������ܹ����⡣

2.�û������Լ�������Ҫ�����ݱ�й¶���ڲ�ϵͳ��Ϊϸ��Ϊ��
	1.1��ϸ�ڷ���:
		1.ĳһ�ƻ������Ľ��̵�ĳһ���̣߳���ĳһ���ض���ʱ�̣������û���������ݣ��ڴ����У����̣�U�̵ȣ���
		2.ͨ���ļ�ϵͳ��ȡ��Ӧ����
		3.ͨ����ѯ�ļ�ϵͳ�������ȷ�ʽ���ҳ���Ӧ��Ӳ���������������е����ݶ�ȡ������
		4.����ʵ�ַ�����
			1.�Խ���RING3��API����hook
			2.���ں��е�API����HOOK
			3.���ں��е��������й���
			4.���ں��е��жϣ�IO�˿ڲ�������HOOK��

	2.�������������Ӧ�����ݽṹ��
		1.���̰������б�����Ӧĳһ��ϵͳ��Ϊ����

	3.�����ṩ��ȫ�����������Ĺ�����Ϣ֧�֡�


**********************************************************************************/

/*********************************************************************************
1. �ض����ܵ���Ʒ�����
	1.WINDOWS �Դ���UNC���ƣ��Ƿ����ʹ�����ֻ��ƻ򱳺�ļܹ���ʵ���ض���

**********************************************************************************/

/**********************************************************************************
����Ϊ��ʽƥ�䷽����
1.����������һ������Ϊ��������У�����������¸���Ϊ��������¸���Ϊ״̬�����û�У�
�򷵻�ԭʼ״̬��
2.����������һ������Ϊ�����У�������������е���Ϊ�������ƥ�䡣
��Զ��ԣ���������ʹ��������������ƥ�䡣

**********************************************************************************/
/*
��һ��Ҫ��ɵĹؼ�������
1.ȷ������Ϊ��ʽ����ƥ���ʵ�ַ�����
2.��ƿ����ض����ܡ�
*/

/*
1.�����򵥵Ļ��ڳ����ļ�ǩ����֤�͹ؼ�ϵͳ������Ϊ�ı���ϵͳ
2.��Ȼ�����Ľ���̫����
*/

/*********************************************************************
sysdiag�������棺
1.�����ܷ��࣬��ÿһ���͵Ĺ��ܼ�������Ϊһ�����ܽṹ�壬��DRIVERENTRY
�г�ʼ�����еĹ��ܽṹ��DRIVERREINIT���ٳ�ʼ������DRIVERUNLOAD�У�����
�еĹ��ܽṹ����ж�أ��ڷ�����SYSDIAG�а�����3�����ܽṹ��

2.SYSDIAG�ڳ�ʼ��������,�ֱ�������ļ�ϵͳ��MINIFILTER,�ں�SSDT HOOK,
TDI�����豸,��WINDOWSϵͳ����������Ҫ�Ļص�������

3.����ÿһ�ֹ��ܽṹ������һ�ױȽϸ��ӵ�DEVICE IO CONTROL���ܡ�

���ܺ���:
�ڻص������н�����ʲô���ݽṹ�Ĵ�������Ϊ���������ʲô��
IO CONTORL��������δ������ԣ����ԵĽṹ��ʲô��

*********************************************************************/

/*********************************************************************
���ܻ�ϵͳ��Ϊ������Ӧϵͳ����Ʋ��裺
1.����ϵͳ��Ϊ�ĺ�����࣬��ʽ��
2.����ϵͳ��Ϊ��΢�۹��̣����衣
3.�������һ�ֹؼ�����Ϊ���з���������
4.��ȡ�ؼ�����Ϊ����������ת��Ϊһ�����Ե���ֵ��
5.���ؼ�����������+��Ϊ��ת��һ�ֿ���ĳ��μ����Է��ֵ���ֵ��������
  Ϊ���Ե㣬��������
6.����Ӧģʽ�����ɷ������򣬻���ʹ��ͨ�õ���ʽ����õ��û���Ӧ�ȡ�
*********************************************************************/

/*********************************************************************
��ȷ����Ϊ������Ӧϵͳ�����й��̽�����һ��״̬��ϵͳ��

��ƥ��Ĳ��Ե���ʽ����ֵ�ڻ���ͬ�������󣬹��̣���Ϊ���ǲ�ͬ�ġ���Ӧ��
Ԥ��Ԥ��Ĳ��ԣ�������������������һ����Ϊ������

*********************************************************************/
/*
��Ϊ�����Ļ���Դ���߳�
�̵߳���Ϊ��¼����:
1.sysdiagʵ�ַ���
	1.ÿ���̶߳�����һ�����ݽṹ,����һ��������¼������,����Ϊ״̬.
	2.
*/

NTSTATUS _check_sys_action( group_policy_nfa *nfa, 
						  action_source_info *source, 
						  r3_action_notify *action, 
						  policy_group_desc **desc )
{
	NTSTATUS ntstatus = STATUS_SUCCESS; 
	action_policy_type policy_type; 
	//event_action_response _resp = { 0 }; 

	do 
	{
		policy_type = action_2_policy_type( action->action.action.type ); 

		ntstatus = nfa_action_group_analyze( nfa, 
			source, 
			action, 
			desc ); 

		if( !NT_SUCCESS( ntstatus ) )
		{
			break; 
		}

	}while( FALSE ); 

_return:
	return ntstatus; 
 }

FORCEINLINE BOOLEAN group_policy_nfa_inited( group_policy_nfa *nfa )
{
	return TRUE; 
}

NTSTATUS check_sys_action( r3_action_notify *action, 
						   action_reply *resp )
{
	NTSTATUS ntstatus = STATUS_SUCCESS; 
	policy_group_desc *desc = NULL; 
	action_source_data source_data; 
	action_source_info *source = NULL;  

	do 
	{
		ASSERT( action != NULL ); 
		ASSERT( resp != NULL ); 
		ASSERT( TRUE == group_policy_nfa_inited( &group_nfa ) ); 

		source_data.proc = ( PVOID )( ULONG_PTR )action->action.ctx.proc_id; 
		source_data.thrd = ( PVOID )( ULONG_PTR )action->action.ctx.thread_id; 

		ntstatus = find_action_source( &source_data, &source ); 
		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

		ASSERT( source != NULL ); 

		ntstatus = _check_sys_action( &group_nfa, 
			source, 
			action, 
 			&desc ); 

		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

		ASSERT( desc != NULL ); 

		*resp = desc->reply; 

	}while( FALSE );

	if( source != NULL )
	{
		ASSERT( source->obj.ref_count >= 1 ); 

		deref_obj( &group_nfa.policy_groups, &source->obj ); 
	}

	if( desc != NULL ) 
	{
		FREE_TAG_POOL( desc ); 
	}

	return ntstatus; 
}

NTSTATUS init_action_check_context()
{
	NTSTATUS ntstatus = STATUS_SUCCESS; 
	BOOLEAN group_policy_dispatch_inited = FALSE; 
	BOOLEAN action_source_table_inited = FALSE; 
	BOOLEAN group_policy_nfa_inited = FALSE; 
	BOOLEAN action_policies_inited = FALSE; 

	do 
	{
		ntstatus = init_group_policy_dispatchs(); 
		if( ntstatus != STATUS_SUCCESS )
		{
			break;
		}

		group_policy_dispatch_inited = TRUE; 

		ntstatus = init_action_sources(); 
		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

		action_source_table_inited = TRUE; 

		ntstatus = init_group_policy_nfa( &group_nfa ); 
		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

		group_policy_nfa_inited = TRUE; 

		ntstatus = load_action_policies(); 
		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

		action_policies_inited = TRUE; 
	}while( FALSE );

	if( ntstatus != STATUS_SUCCESS )
	{
		if( group_policy_dispatch_inited == TRUE )
		{
			uninit_group_policy_dispatchs(); 
		}

		if( action_source_table_inited == TRUE )
		{
			uninit_action_sources(); 
		}


		if( group_policy_nfa_inited == TRUE )
		{
			uninit_group_policy_nfa( &group_nfa ); 
		}
	}

	return ntstatus; 
}

NTSTATUS uninit_action_check_context()
{
	NTSTATUS ntstatus = STATUS_SUCCESS; 

	do 
	{
		ntstatus = uninit_action_sources(); 
		if( ntstatus != STATUS_SUCCESS )
		{
			ASSERT( FALSE ); 
			log_trace( ( MSG_FATAL_ERROR, "uninit action sources error 0x%0.8x\n", ntstatus ) ); 
		}

		ntstatus = uninit_group_policy_nfa( &group_nfa ); 
		if( ntstatus != STATUS_SUCCESS )
		{
			ASSERT( FALSE ); 
			log_trace( ( MSG_FATAL_ERROR, "uninit group policy nfa error 0x%0.8x\n", ntstatus ) ); 
		}

	}while( FALSE ); 

	return ntstatus; 
}
/*************************************************************
��1�汾�����ƻ���
1.ʵ��Ӧ�ò����Ϊ������ϵͳ.
	1.���ں��н�ȡ�����е��й�����ΪԴ����Ϊ�����ݡ�
	2.ͨ��Ӧ�ò�����н�ȡ������Ϊ�ķ�������ɲ���ϵͳ����״̬����

2.���и�������ļ�֤������ 

3.��Ч�ʽǶȣ�����Ч�������ܽǶȳ����������ֲ������л��������ں�̬��
*************************************************************/

/*************************************************************
what do i want to do?
i want distinguish the all modified data 
( in disk, memory, network ) by the action in system.
*************************************************************/

/****************************************************************
ʵ�ְ�ȫ���������ּ�����
1.������
2.��̬������+��̬ɱ������
3.��̬��Ϊ����

BITSAFE�������з������Ƕ�̬��Ϊ���������������Ƴ��ǳ�����������
�İ������Ļ���Ҳ���Կ��Ƕ�������з���

��̬�����ı����Ƕ�����Դ��ָ�����е�����������Խ��з�������λ��
��Ҫ����Ӧ��̬�⡣

��̬���������ڻ�û���Զ��������������������ʵ����Ҫ���ܻ�������
��ǰ��û�й����ĳ������������

��������Ҳ�Ǿ�̬�ģ���Ҫ������̬�⡣���ľ�̬�������ԣ������ԣ�
�������Ƿ����õĹؼ���Ҳ�Ǽ�����ͻ�ƵĹؼ��㡣
��������ƹ��룺
1.�Ƿ�������ô������˵ķ�����ʹ�þ��飬����һ���ǳ������Ƶ���
�Ű�����ϵͳ��
****************************************************************/

NTSTATUS load_test_policies()
{
	NTSTATUS ntstatus = STATUS_SUCCESS; 
	policy_group_desc *desc = NULL; 
	policy_group *group = NULL; 
	group_action_policy *policy; 

	do 
	{
		desc = ( policy_group_desc* )ALLOC_TAG_POOL( DEFAULT_POLICY_GROUP_LENGTH ); 

		if( desc == NULL )
		{
			ntstatus = STATUS_INSUFFICIENT_RESOURCES; 
			break; 
		}
#define TEST_POLICY_GROUP_DESC L"test"
		memcpy( desc->desc, TEST_POLICY_GROUP_DESC, sizeof( TEST_POLICY_GROUP_DESC ) ); 
		desc->desc_len = CONST_STR_LEN( TEST_POLICY_GROUP_DESC ) + 1; 
		desc->id = 0; 
		desc->level = 1; 
		desc->reply = ACTION_BLOCK; 

		ntstatus = add_policy_group( &group_nfa, 
			desc, 
			&group ); 

		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}
		}
		}
		}

#define TEST_FILE_READ_POLICY_PATH L"\\Device\\HarddiskVolume1\\test\\1.txt"

		policy = malloc( sizeof( group_action_policy ) + ( _MAX_REG_PATH_LEN << 1 ) ); 
		if( policy == NULL )
		{
			log_trace( ( MSG_FATAL_ERROR, "allocate the buffer for policy loading error\n" ) ); 
			break; 
		}

		policy->policy.type = FILE_read; 
		policy->policy.do_file_read.offset = 0; 
		policy->policy.do_file_read.data_len = 0; 
		policy->policy.do_file_read.path_len = CONST_STR_LEN( TEST_FILE_READ_POLICY_PATH ); 
		policy->policy.size = FIELD_OFFSET( action_policy, do_file_read ) + sizeof( _file_read ) + sizeof( TEST_FILE_READ_POLICY_PATH ); 

		memcpy( policy->policy.do_file_read.path_name, TEST_FILE_READ_POLICY_PATH, sizeof( TEST_FILE_READ_POLICY_PATH ) ); 

		ntstatus = add_policy_to_group( &group_nfa, 
			&policy, 
			group ); 

		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

#define TEST_REG_KEY_PATH L"HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet002\\Services\\WinSock2\\Parameters"
#define TEST_REG_VALUE_NAME	L"WinSock_Registry_Version"

		//ULONG type; //ע���ֵ���� 
		//ULONG data_len; //���ݳ��� 
		//PATH_SIZE_T path_len; 
		//PATH_SIZE_T val_name_len; 

		////NTSTATUS result; //������ɽ��(NTSTATUS) 
		//WCHAR path_name[ 1 ]; //ע���ֵ·�� 

		policy->policy.type = REG_getval; 
		policy->policy.do_reg_getval.type = REG_DWORD; 
		policy->policy.do_reg_getval.data_len = 4; 
		policy->policy.do_reg_getval.path_len = CONST_STR_LEN( TEST_REG_KEY_PATH ); 
		policy->policy.do_reg_getval.val_name_len = CONST_STR_LEN( TEST_REG_VALUE_NAME ); 

		memcpy( policy->policy.do_reg_getval.path_name, TEST_REG_KEY_PATH, sizeof( TEST_REG_KEY_PATH ) ); 
		policy->policy.do_reg_getval.path_len = CONST_STR_LEN( TEST_REG_VALUE_NAME ); 
		memcpy( ( policy->policy.do_reg_getval.path_name + policy->policy.do_reg_getval.path_len + 1 ), 
			TEST_REG_VALUE_NAME, 
			sizeof( TEST_REG_VALUE_NAME ) ); 

		policy->policy.size = FIELD_OFFSET( action_policy, do_reg_getval ) 
			+ sizeof( reg_getval ) 
			+ sizeof( TEST_REG_KEY_PATH ) 
			+ sizeof( TEST_REG_VALUE_NAME ); 

		ntstatus = add_policy_to_group( &group_nfa, 
			&policy, 
			group ); 

		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

	}while( FALSE );

	if( group != NULL )
	{
		deref_obj( &group_nfa.policy_groups, 
			&group->obj ); 
	}

	return ntstatus; 
}

NTSTATUS load_action_policies()
{
	NTSTATUS ntstatus = STATUS_SUCCESS; 

	do 
	{

#ifdef _DEBUG
		ntstatus = load_test_policies(); 
		if( ntstatus != STATUS_SUCCESS )
		{
			break; 
		}

#endif //_DEBUG
	}while( FALSE );

	return ntstatus; 
}
